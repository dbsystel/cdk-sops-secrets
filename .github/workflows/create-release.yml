name: create-release

on:
  workflow_dispatch: {}

permissions:
  contents: write
  actions: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: 'lts/*'

      - name: Install mise
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3
        with:
          experimental: true

      - name: Install dependencies
        run: mise run install

      - name: Set git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Create version and tag
        id: version
        run: |
          # Run commit-and-tag-version to bump version, update changelog, and create tag
          npx commit-and-tag-version

          # Get the new version tag
          NEW_TAG=$(git describe --tags --abbrev=0)
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

          # Extract changelog for this version
          # This extracts content between the first two version headers
          CHANGELOG_CONTENT=$(awk '/^## \[/{if(++count==2) exit; if(count==1) next} count==1' CHANGELOG.md)

          # Save changelog to file for multiline handling
          echo "$CHANGELOG_CONTENT" > /tmp/release_notes.md

          echo "Prepared release $NEW_TAG"

      - name: Create release branch and PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create and push release branch (local tag not pushed)
          BRANCH_NAME="release/${{ steps.version.outputs.new_tag }}"
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
          
          # Create pull request with tag info in body
          echo "## Release ${{ steps.version.outputs.new_tag }}" > /tmp/pr_body.md
          echo "" >> /tmp/pr_body.md
          echo "This PR will create tag \`${{ steps.version.outputs.new_tag }}\` when merged." >> /tmp/pr_body.md
          echo "" >> /tmp/pr_body.md
          cat /tmp/release_notes.md >> /tmp/pr_body.md
          
          gh pr create \
            --title "Release ${{ steps.version.outputs.new_tag }}" \
            --body-file /tmp/pr_body.md \
            --base main \
            --head "$BRANCH_NAME"

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create GitHub release using the changelog content
          gh release create ${{ steps.version.outputs.new_tag }} \
            --title "${{ steps.version.outputs.new_tag }}" \
            --notes-file /tmp/release_notes.md

      - name: Trigger release workflow on tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Manually trigger the 'release' workflow on the new tag ref
          # Using workflow_dispatch with ref to run on the tag
          gh workflow run release.yml --ref ${{ steps.version.outputs.new_tag }}
